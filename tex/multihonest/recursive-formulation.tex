In this section, we introduce additional elements of the fork framework from~\citet{LinearConsistency}, 
most notably the notions of ``reach'' and ``relative margin.'' 
We show that relative margin is just as expressive 
as the Catalan slots 
for characterizing slot settlement. 
Next, we prove a recurrence relation for relative margin; 
it can be used to compute 
the probability that a given slot is $k$-settled, 
when the symbols of the characteristic string are i.i.d\ .
Finally, we present an adversary who, 
given a characteristic string one symbol at a time, 
optimally attacks the settlement of all slots at once. 


\input{reach-and-margin}






\subsection{Balanced forks, settlement violations, and relative margin}
%Informally, $t_1\sim_x t_2$ indicates that when we restrict our view of history to only blocks \emph{after}
%the prefix $x$, $t_1$ and $t_2$ share an edge (and thus agree on at least one block after that point).

A natural structure we can use to reason about settlement times 
(see Definition~\ref{def:settlement}) 
is that of a ``balanced fork.''

\begin{definition}[Balanced fork]\label{def:balanced-fork} A
  fork $F$ is \emph{balanced} if it contains a pair of tines $t_1$ and
  $t_2$ for which $t_1\nsim t_2$ and
  $\length(t_1)=\length(t_2)=\height(F)$. We define a relative notion
  of balance as follows: a fork $F \vdash xy$ is \emph{$x$-balanced}
  if it contains a pair of tines $t_1$ and $t_2$ for which
  $t_1 \not\sim_x t_2$ and $\length(t_1) = \length(t_2) = \height(F)$.
\end{definition}

Thus, balanced forks contain two completely disjoint, maximum-length
tines, while $x$-balanced forks contain two maximum-length tines that
may share edges in $x$ but must be disjoint over the rest of the
string. 
See Figures~\ref{fig:balanced} and~\ref{fig:x-balanced} 
for examples of balanced forks.
\begin{figure}[ht]
  \centering
  \begin{minipage}{0.45\textwidth}\centering


    \begin{tikzpicture}[>=stealth', auto, semithick,
      honest/.style={circle,draw=black,thick,text=black,double,font=\small},
     malicious/.style={fill=gray!10,circle,draw=black,thick,text=black,font=\small}]
      \node at (0,-2) {$w =$};
    \node at (1,-2) {$\h$}; \node[honest] at (1,-.7) (b1) {$1$};
    \node at (2,-2) {$\A$}; \node[malicious] at (2,.7) (a1) {$2$};
    \node at (3,-2) {$\h$}; \node[honest] at (3,.7) (a2) {$3$};
    \node at (4,-2) {$\A$}; \node[malicious] at (4,-.7) (b2) {$4$};
    \node at (5,-2) {$\h$}; \node[honest] at (5,-.7) (b3) {$5$};
    \node at (6,-2) {$\A$}; \node[malicious] at (6,.7) (a3) {$6$};
      \node[honest] at (-1,0) (base) {$0$};
    \draw[thick,->] (base) to[bend left=10] (a1);
        \draw[thick,->] (a1) -- (a2);
        \draw[thick,->] (a2) -- (a3);
    \draw[thick,->] (base) to[bend right=10] (b1);
        \draw[thick,->] (b1) -- (b2);
        \draw[thick,->] (b2) -- (b3);
      \end{tikzpicture} 
    \caption{A balanced fork}
    \label{fig:balanced}
  % \end{figure}
  \end{minipage}
  \hfill
  \begin{minipage}{0.45\textwidth}\centering

  % \begin{figure}[ht]
  %   \centering
    \begin{tikzpicture}[>=stealth', auto, semithick,
      honest/.style={circle,draw=black,thick,text=black,double,font=\small},
     malicious/.style={fill=gray!10,circle,draw=black,thick,text=black,font=\small}]
      \node at (0,-2) {$w =$};
    \node at (1,-2) {$\h$}; \node[honest] at (1,0) (ab1) {$1$};
    \node at (2,-2) {$\h$}; \node[honest] at (2,0) (ab2) {$2$};
    \node at (3,-2) {$\h$}; \node[honest] at (3,.7) (a3) {$3$};
    \node at (4,-2) {$\A$}; \node[malicious] at (4,-.7) (b3) {$4$};
    \node at (5,-2) {$\h$}; \node[honest] at (5,-.7) (b4) {$5$};
    \node at (6,-2) {$\A$}; \node[malicious] at (6,.7) (a4) {$6$};
      \node[honest] at (-1,0) (base) {$0$};
    \draw[thick,->] (base) -- (ab1);
    \draw[thick,->] (ab1) -- (ab2);
    \draw[thick,->] (ab2) to[bend left=10] (a3);
      \draw[thick,->] (a3) -- (a4);
    \draw[thick,->] (ab2) to[bend right=10] (b3);
      \draw[thick,->] (b3) -- (b4);
      \end{tikzpicture} 
    \caption{An $x$-balanced fork, where $x=\h\h$}
    \label{fig:x-balanced}

  \end{minipage}
\end{figure}


% \paragraph{Balanced forks and settlement time.}
A fundamental question arising in typical blockchain settings is how
to determine \emph{settlement time}, the delay after which the
contents of a particular block of a blockchain can be considered
stable. The existence of a balanced fork is a precise indicator for
``settlement violations'' in this sense. Specifically, consider a
characteristic string $xy$ and a transaction appearing in a block
associated with the first slot of $y$ (that is, slot $|x| + 1$). One
clear violation of settlement at this point of the execution is the
existence of two chains---each of maximum length---which diverge
\emph{prior to $y$}; in particular, this indicates that there is an
$x$-balanced fork $F$ for $xy$. Let us record this observation below.\footnote{
  A balanced fork in~\cite{LinearConsistency} 
  had the property that 
  at least one maximum-length tine was adversarial. 
  But this is not true in our setting since we allow multiply honest slots.
}


\begin{observation}\label{obs:settlement-balanced-fork}
  Let $s, k \in \NN$ be given and 
  let $w$ be a characteristic string. 
  Slot $s$ is not $k$-settled for the characteristic string $w$ 
  if 
  there exist a decomposition $w = xyz$, 
  where $|x| = s - 1$ and $|y| \geq k+1$, 
  and an $x$-balanced fork for $xy$. 
\end{observation}

In particular, to provide a rigorous $k$-slot settlement
guarantee---which is to say that the transaction can be considered
settled once $k$ slots have gone by---it suffices to show that with
overwhelming probability in choice of the characteristic string
determined by the leader election process (of a full execution of the
protocol), no such forks are possible. Specifically, if the protocol
runs for a total of $T$ time steps yielding the characteristics string
$w = xy$ (where $w \in \{0,1\}^T$ and the transaction of interest
appears in slot $|x| + 1$ as above) then it suffices to ensure that
there is no $x$-balanced fork for $x\hat{y}$, where $\hat{y}$ is an
arbitrary prefix of $y$ of length at least $k + 1$. 
% see Corollary~\ref{cor:main} in Section~\ref{sec:estimates}.  
Note that
for systems adopting the longest chain rule, this condition must
necessarily involve the \emph{entire future dynamics} of the
blockchain. We remark that our analysis below will in fact let us take
$T = \infty$.


% \paragraph{An alternative proof of Lemma~\ref{lemma:uvp-margin} via balanced forks.}
Let $w$ be a characteristic string. 
Writing $w = xy$, 
consider any tine-pair $(t_x, t_\rho)$ in a fork $F \Fork w$ so that 
$\reach_F(t_\rho) = \rho(F)$ and $t_x$ is $y$-disjoint with $t_\rho$.
Observe that if $\mu_x(y) < 0$ then $\reach_F(t_x) < 0$. 

% In a similar Fact 1 in~\cite{LinearConsistencySODA}, 
\begin{fact}\label{fact:margin-balance}
  Let $xy \in \{\h, \H, \A\}^*$ be a characteristic string. 
  There is no 
  $x$-balanced fork for $xy$ 
  if and only if 
  $\mu_x(y) < 0$.
\end{fact}
\begin{proof}[Proof sketch.]  
  If a fork $F \Fork xy$ 
  satisfies $\mu_x(F) \geq 0$, 
  it contains two $y$-disjoint tines $t_1, t_2$, 
  each with a non-negative reach, 
  so that $\min(\reach(t_1), \reach(t_2)) = \mu_x(F)$. 
  As $\reserve(t_i) \geq \gap(t_i)$ for $i \in \{1,2\}$, 
  we can extend these tines using only new adversarial vertices 
  so that both these extensions 
  have the maximum length 
  in the augmented fork. 
  Thus the augmented fork is $x$-balanced.

  On the other hand, if a fork $F \Fork xy$ is $x$-balanced, 
  there must be two $y$-disjoint 
  maximum-length tines $t_1, t_2 \in F$. 
  As the gap of a maximum-length tine is zero, 
  we must have $\reach(t_i) = \reserve(t_i) \geq 0$ 
  for $i \in \{1, 2\}$. 
  It follows that $\mu_x(y) \geq \mu_x(F) \geq \min_i \reach(t_i) \geq 0$.
\end{proof}

% Let us focus on proving Lemma~\ref{lemma:uvp-margin} 
% using the above fact. 
% Let $x\Prefix w$. 
% It is easy to see that 
% if the slot $s = |x| + 1$ has the UVP 
% then there can be no $x$-balanced fork for $xx'$ 
% where $xx' \PrefixEq w$;
% consequently, $\mu_x(x') < 0$. 
% On the other hand, if $s$ does not have the UVP 
% then there must be a prefix $xx' \PrefixEq w$ 
% and a fork $F \Fork xx'$ 
% containing two maximum-length (and hence viable) 
% tines $t_1, t_2$ 
% diverging prior to slot $s$. 
% Hence $F$ is $x$-balanced.
% \hfill\qed


\subsection{Relative margin 
to characterize 
the UVP}
Let $w$ be a characteristic string. 
Recall that in Theorem~\ref{thm:unique-honest}, 
we showed that whether a slot has the UVP in $w$ --- a 
structural property of the forks for $w$ --- is 
characterized by the ``Catalan-ness'' of the said slot. 
Below, we show that relative margin 
has the same expressive power 
as the Catalan slots 
in terms of characterizing the UVP. 


  
% \begin{definition}[Margin-critical slot]\label{def:margin-critical-slot}
%     Let $w \in \{\h,\H,\A\}^T$ be a characteristic string, 
%     $s \in [T]$ be a slot in $w$, 
%     and $x$ be a prefix of $w$ so that $|x| = s - 1$. 
%     Slot $s$ is called \emph{margin-critical} 
%     if, 
%     for all decompositions 
%     $w = xyz$ so that $|y| \geq 1$ and $|z| \geq 0$, 
%     we have $\mu_{x}(y) < 0$.
%     % for all decompositions $w = xyz$ so that $|x| < s, |xy| \geq s$.    
% \end{definition}
% Since $\mu_x(\varepsilon) \geq 0$ and $|y| \geq 1$ in the above definition, 
% it follows that a margin-critical slot (i.e., the first slot in $y$) must be honest.




% Below, we show that a margin-critical honest slot has the bottleneck property as well. 
\begin{lemma}\label{lemma:uvp-margin}
  Let $T \in \NN, w \in \{\h, \H, \A\}^T$, and 
  $s \in [T]$ so that $w_s = \h$. 
  Let $x = w_1 \ldots w_{s-1}$.
  Slot $s$ has the UVP in $w$ 
  if and only if 
  for every prefix $xy \PrefixEq w$, 
  $\mu_x(y) < 0$. 
  % A a uniquely honest slot is margin-critical 
  % if and only if 
  % it has the UVP. 
\end{lemma}


% \begin{corollary}\label{coro:catalan-margin-critical}
%   Let $w \in \{\h, \H, \A\}^T$ be a characteristic string 
%   and let $x \PrefixEq$ 
%   A uniquely honest slot in $w$ 
%   is Catalan 
%   if and only if 
%   % it is margin-critical. 
%   for every prefix $xy \PrefixEq w$, 
%   $\mu_x(y) < 0$. 
% \end{corollary}

\begin{proof}~
  % Recall from Theorem~\ref{thm:unique-honest} 
  % that a uniquely honest slot is Catalan in $w$ 
  % if and only if 
  % it has the UVP in $w$. 

  \begin{description}[font=\normalfont\itshape\space]
    \item[The $\Longleftarrow$ direction.]
      Suppose that 
      for every prefix $xy \PrefixEq w$ where $|y| \geq 1$, 
      we have $\mu_x(y) < 0$. 
      We wish to show that $s$ has the UVP in $w$.

      Let $F$ be any fork for $xy$ 
      and let 
      $t \in F, \ell(t) \leq s - 1$ be an honest tine. 
      Since it is disjoint with any tine in $F$ over the suffix $y$, 
      $\reach(t) < 0$ and, by Fact~\ref{fact:fork-structure-reach}, 
      $t$ does not have an adversarial extension $t' \in F, t \Prefix t'$ that is 
      viable at the onset of slot $|xy| + 1$. 
      Therefore, if a tine in $F$ 
      is viable at the onset of slot $|xy| + 1$, 
      it must contain an honest vertex with label at least $s$. 
      However, since an honest vertex builds only on top of a viable tine, 
      it follows that any viable tine must contain 
      the unique honest vertex with label $s$.

    \item[The $\Longrightarrow$ direction.]
      Suppose $s$ has the UVP in $w$.
      Let $k \in [s, T]$ be an integer and 
      write $w = xyz$ with $|xy| = k$. 
      (Note that $y_1 = w_s$.)
      We wish to show that $\mu_x(y) < 0$.

      Let $F$ be any fork for $xy$.
      % all tines in $F$ viable at the onset of 
      % % slot $|xy| + 1$ 
      % slot $|xy| + 1$ 
      % have, as their common prefix, 
      % {\color{blue}the unique honest tine} $\tau, \ell(\tau) = s$. 
      Since slot $s$ belongs to $y$, 
      $F$ cannot contain two tines 
      such that 
      \begin{enumerate*}[label=(\roman*)]
        \item both tines are viable at the onset of slot $|xy| + 1$ 
        and, at the same time, 
        \item disjoint over the length of $y$ 
        since they must contain the unique vertex with label $s$. 
      \end{enumerate*}
      % As any $x$-balanced fork for $xy$ requires two maximally long tines 
      % that are disjoint over $y$, 
      In particular, 
      $F$ cannot be $x$-balanced. 
      As $F$ was an arbitrary fork for $xy$, 
      no fork for $xy$ can be $x$-balanced for our choice of $k$.
      We use Fact~\ref{fact:margin-balance} 
      to conclude that 
      $\mu_x(y)$ must be negative.
      % Since our $k \in [s, T]$ is arbitrary, 
      % the above conclusion applies to 
      % all decompositions $w = xyz$ where $|x| = s - 1$ and $|xy| \geq s$.
      % Therefore, slot $s$ is margin-critical in $w$.

  \end{description}
\end{proof}









\subsection{An optimal online adversary against slot settlement}
\label{sec:opt-adversary}
Let $w$ be a characteristic string. 
For a fixed decomposition $w = xy$, 
there is an adversary\footnote{
  Specifically, 
  let $w' = xyb$ 
  where $b \in \{\h, \H, \A\}$. 
  This strategy recursively builds a closed fork $F \Fork xy$. 
  Then, upon encountering $b$, 
  it augments $F$ 
  by making zero, one, or two conservative extensions, as follows: 
  If $b = \A$, it does nothing. 
  If $b = \h$, it extends a zero-reach tine if possible; 
  otherwise,it extends a maximum-reach tine. 
  If $b = \H$, it extends a pair of tines that 
  witness $\mu_x(F)$. 
  By following the arguments in~\cite{LinearConsistencySODA}, 
  one can show that 
  if $\mu_x(F) = \mu_x(y)$ then 
  $\mu_x(F')$ is 
  at least as large as 
  the right-hand side in~\eqref{eq:mu-relative-recursive}.   
} 
who builds a fork $F \Fork xy$ 
so that the $\mu_x(F)$ is 
at least as large as 
the right-hand side of~\eqref{eq:mu-relative-recursive}. 
However, 
in light of Lemma~\ref{lemma:uvp-margin}, 
if an adversary wants to violate the settlement 
\emph{of all possible slots of $w$ at once}, 
% to show that the lowerbound is satisfied 
% \emph{simultaneously} 
% for all decompositions $w = xy$, 
% one has to do more work.
he needs to produce a fork $F$ for $w$ 
so that $\mu_x(F) \geq 0$ 
for every prefix $x \PrefixEq w$. 
In Figure~\ref{fig:adv-opt}, 
we describe a strategy $\Adversary^*$ 
which does even better: 
it produces a fork $F$ so that $\mu_x(F) = \mu_x(y)$ 
for every prefix $x \PrefixEq w$. 


$\Adversary^*$ builds a fork for $w = w_1 \ldots w_{n+1}$ 
in an online fashion, i.e., 
it scans $w$ once, from left to right, 
maintains a fork $F_n$ after scanning 
the first $n$ symbols, 
and augments $F_n$ by conservatively extending 
zero-reach tine(s) using label $n + 1$.
Specifically, if $w_{n+1} = \A$, $\Adversary^*$ does nothing. 
If $w_{n+1} = \h$, it (obviously) makes a single extension. 
Now suppose $w_{n+1} = \H$. 
It still makes a single extension
if either $F_n$ contains exactly one zero-reach tine 
or $F_n$'s reach is positive. 
Otherwise, 
if $\rho(F_n) = 0$ 
and there are at least two zero-reach tines in $F_n$, 
$\Adversary^*$ extends two zero-reach tines 
that diverge earliest in $F_n$.



\begin{figure}[!h]
  \begin{center}
    \fbox{
      \begin{minipage}{.9 \textwidth}
        \begin{center}
          \textbf{The strategy $\Adversary^*$}
        \end{center}
        Let $n$ be a non-negative integer, 
        $w \in \{\h, \H, \A\}^n$, 
        and $w_{n + 1} \in \{\h, \H, \A\}$. 
        If $n = 0$, set $F_0 \Fork \varepsilon$ as 
        the trivial fork comprising a single vertex. 
        Otherwise, 
        let $F_n$ be the closed fork 
        built recursively by $\Adversary^*$ for the string $w$. 
        If $w_{n + 1} = \A$, 
        output $F_n$ (as a fork for $w w_{n+1}$). 
        Otherwise, 
        let $Z$ and $R$ be the set of zero-reach tines 
        and maximum-reach tines in $F_n$, respectively.

        \begin{enumerate}
          \item 
          Identify a set $S$ as follows: 
          If $|Z| = 1$ then set $S = Z$. 
          Otherwise, 
          let $r_1 \in R, z_1 \in Z$ be two tines so that 
          $\ell(r_1 \Intersect z_1) = 
          \min\{ \ell(r \Intersect z) :  r \in R, z \in Z \}$ 
          and set  
          \[
          S = \begin{cases}
            \{z_1\} & \text{
              if $w_{n + 1} = \h$ 
              or $\rho(F_n) \geq 1$ 
              % or for all prefix $x \Prefix w$, $\mu_x(F_n) < 0$}
              % or $|Z| = 1$
              }\,, \\
            \{z_1, r_1\} & \text{otherwise}\,.
          \end{cases}
          \]

          \item
          Conservatively extend 
          each tine in $S$ 
          using label $n + 1$. 
          Let $F_{n + 1} \Fork w w_{n+1}$ 
          be the new closed fork. 
          Output $F_{n+1}$.
        \end{enumerate}
      \end{minipage}
    }
  \end{center}
  \caption{Optimal online adversary $\Adversary^*$}
  \label{fig:adv-opt}
\end{figure}






\begin{definition}[Canonical fork]
  A \emph{canonical fork} for $w \in \{\h, \H, \A\}^*$ 
  is a closed fork $F \Fork w$ so that 
  $\rho(F) = \rho(w)$ 
  and, for all prefixes $x \Prefix w$, $\mu_x(F) = \mu_x(y)$. 
  If $|w| = 0$, $F$ is 
  the unique fork with a single (honest) vertex and no edge. 
  % Let $w_1 \ldots w_T \in \{0,1\}^T$. 
  % For $n = 0, 1, \ldots, T$, a \emph{canonical fork $F_n$ for $w = w_1\ldots w_n$} 
  % is inductively defined as follows. 
  % If $n = 0$ then $F_0$ is the trivial fork for the empty string; 
  % it consists of a single (honest) vertex and no edge. 
  % If $n \geq 1$, the following holds: 
  % $F_n$ is a closed fork so that $F_{n-1} \ForkPrefix F_n$. 
  % $F_n$ contains an honest tine $\tau_\rho$ so that 
  % $\reach(\tau_\rho) = \rho(F_n) = \rho(w)$. 
  % For every decomposition $w = xy, x \Prefix w$, 
  % % $\mu_x(F_n) = \mu_x(y)$ and, in addition, 
  % $F_n$ contains two honest tines $\tau_x, \tau_{\rho x}$ 
  % so that the tine-pair $(\tau_{\rho x}, \tau_x)$ witnesses $\mu_x(F_n) = \mu_x(y)$. 
  % The (possibly non-distinct) designated tines $\tau_\rho, \tau_{\rho x}, \tau_x, x \Prefix w$ 
  % are called the \emph{witness tines}. 
  % For the sake of completeness, define $\tau_w = \tau_{\rho w} = \tau_\rho$.
\end{definition}

It is not obvious whether a canonical fork always exists 
or whether it can be found algorithmically. 
The theorem below gives us the assurance:


\begin{theorem}\label{thm:opt-adversary-canonical}
  Let $w \in \{\h, \H, \A\}^*$. 
  The strategy $\Adversary^*$ in Figure~\ref{fig:adv-opt}
  outputs a canonical fork for $w$.  
\end{theorem}
That is, for every characteristic string $w$ 
there is a fork $F \Fork w$ so that 
for every prefix $x \PrefixEq w$, $\mu_x(F) = \mu_x(y)$. 
Note that if one's objective is to create a fork 
which contains many early-diverging tine-pairs (that witness large relative margins), 
a canonical fork is the best one can hope for. 
This is why $\Adversary^*$ is called an \emph{optimal} online adversary. 
The proof of Theorem~\ref{thm:opt-adversary-canonical} 
is given in Section~\ref{sec:margin-proof}.






