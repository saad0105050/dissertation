%There are portions of this file which are editable, and portions which should not be adjusted.  I've clearly labeled the section where your customizations should be written.

%%%%%%%%%%%%%%%%%%%%
%%                   Do not edit!!!                     %%
%%%%%%%%%%%%%%%%%%%%
\usepackage{
	amsmath, 
	amsthm, 
	amssymb,
	fancyhdr, 
	setspace, 
}
\usepackage[
	paper=letterpaper,
	left=1.5in,
	top=1in,
	bottom=1in,
	right=1in,
	includehead,
	includefoot
]
{geometry}
\usepackage[titles]{tocloft}
\setlength{\cftbeforechapskip}{2ex}
\setlength{\cftbeforesecskip}{0.5ex}
\renewcommand{\cftchapfont}{\bfseries}
\renewcommand{\cftchapaftersnum}{.}
\renewcommand{\cftsecfont}{}
\renewcommand{\cftchappagefont}{\mdseries}
\renewcommand\cftchappresnum{Ch.\,}
\setlength{\cftchapnumwidth}{3.75em}
\usepackage{sectsty}
\allsectionsfont{\singlespacing}
\pagestyle{fancy} 
\rhead{\thepage}
\cfoot{}
\lhead{}
\chead{}
\renewcommand{\headrulewidth}{0pt} 
\renewcommand{\footrulewidth}{0pt}

%%%%%%%%%%%%%%%%%%%%
%%%%%            Editable            %%%%%
%%%%%%%%%%%%%%%%%%%%

%\usepackage{<add your packages>}
\usepackage[titletoc]{appendix}
\usepackage[center,small,sc]{caption,subcaption}
\usepackage{array}
\usepackage{subfiles}
\usepackage{accents}
\usepackage{multirow}
\usepackage{pgfgantt}
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage[inline]{enumitem}
\usepackage{blindtext}
\usepackage{hhline}
\usepackage{multirow}
\usepackage{etoolbox}
\usepackage{mathtools}
\usepackage{lscape}
\usepackage{color}
\usepackage{framed}
\usepackage{xcolor}
\usepackage{hyperref}
\hypersetup{% No ugly red box around the link
    colorlinks,
    linkcolor={red!50!black},
    citecolor={blue!50!black},
    urlcolor={blue!80!black}
}
\newcommand{\quotebox}[1]{\begin{center}%
    \vspace{1em}%
    \fcolorbox{white}{blue!15!gray!15}{%
        \begin{minipage}{0.9\linewidth}%
            \vspace{10pt}\center%
            \begin{minipage}{0.85\linewidth}%
                {\space\Huge\hspace{-1em}``\vspace{-1em}}{#1}%{\hspace{1.5em}\break\null\Huge\hfill''}%
            \end{minipage}%
            %{\hspace{1.5em}\break\null\Huge\hfill''\quad}%
            {\break\null\Huge\hfill''}%
            \smallbreak\end{minipage}%
    }%
    \end{center}%
    \vspace{1em}%
}%
\usepackage{epigraph}
\newcommand{\Epigraph}[2]{
    \epigraphhead[70]{\epigraph{#1}{\textit{#2}}}
}
% \newcommand{\EpigraphBig}[2]{
%     \dropchapter{2in}
%     \chapter{#}
%     \epigraphhead{long epigraph}
%     \undodrop
% }


\usepackage[numbers,sectionbib]{natbib}
\usepackage{bibentry}
\nobibliography*


% Requires package etoolbox
\newtoggle{Dissertation}
\toggletrue{Dissertation}

\iftoggle{Dissertation} {
	\newcommand{\Section}{Chapter}
    \newcommand{\InThisPaper}{Dissertation}
}{
	\newcommand{\Section}{Section}
    \newcommand{\InThisPaper}{paper}
}

%%%%%%%%%%%%%%%%%%
% \usepackage{stix2}




%%%%%%%%%%%%%%%%%%%%
% Common macros
\newtheorem{theorem}{Theorem}[chapter]
\newtheorem*{theorem*}{Theorem}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{claim}[theorem]{Claim}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{observation}[theorem]{Observation}
\newtheorem{bound}[theorem]{Bound}
\newtheorem{fact}[theorem]{Fact}
\newtheorem*{fact*}{Fact}

\theoremstyle{definition}
\newtheorem{remark}[theorem]{Remark}
\newtheorem*{remark*}{Remark}


\newcommand{\ignore}[1]{}


%%%%%%%%%%%%%%%%%%%%%%%
% Consistency macros
\newcommand\gmargin{\mathbf{m}}
\DeclareMathOperator{\Exp}{\mathbb{E}}
\DeclareMathOperator{\argmax}{arg\,max}
\DeclareMathOperator{\argmin}{arg\,min}
\newcommand{\gf}[1]{\mathsf{#1}}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\ZZ}{\mathbb{Z}}
\newcommand{\CC}{\mathbb{C}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\NN}{\mathbb{N}}
\newcommand{\hdepth}{\mathbf{d}}
\DeclareMathOperator{\length}{length}
\DeclareMathOperator{\depth}{depth}
\DeclareMathOperator{\height}{height}
\DeclareMathOperator{\gap}{gap}
\DeclareMathOperator{\reach}{reach}
\DeclareMathOperator{\reserve}{reserve}
\DeclareMathOperator{\divergence}{div}
\DeclareMathOperator{\tdivergence}{tdiv}
\newcommand{\slot}{\textsl{sl}}
\newcommand{\Slot}{\textsl{sl}}
\newcommand{\fprefix}{\sqsubseteq}
\newcommand{\Adversary}{\mathcal{A}}
\newcommand{\Challenger}{\mathcal{C}}
\newcommand{\Distribution}{\mathcal{D}}
\newcommand{\dominatedby}{\preceq}
\newcommand{\StationaryRho}{\mathcal{R}_\infty}
\newcommand{\DistRho}{\mathcal{R}}
\newcommand{\Poly}{\mathrm{poly}}
\newcommand{\SuchThat}{:}
\newcommand{\Given}{\mid}
\newcommand{\Union}{\cup}
\newcommand{\BigUnion}{\bigcup}
\newcommand{\PrefixEq}{\preceq}
\newcommand{\Prefix}{\prec}
\newcommand{\ForkPrefix}{\fprefix}
\newcommand{\Trim}[1]{^{\lceil {#1}}}
% \newcommand{\TrimSlot}[1]{\left[1:-{#1}\right]}
\newcommand{\TrimSlot}[1]{^{\lceil {#1}}}
\newcommand{\Fork}{\vdash}
\newcommand{\pinch}[2]{{#2}^{\vartriangleright {#1} \vartriangleleft} }
\newcommand{\cut}[2]{{#2}^{{#1} \vartriangleleft} }
\newcommand{\Chain}{\mathcal{C}}
\newcommand{\Intersect}{\cap}
\newcommand{\SlotCP}{\mathrm{CP}^{\mathsf{slot}}}
\newcommand{\kSlotCP}[1][k]{{#1}\text{-}\SlotCP}
\newcommand{\CP}{\mathrm{CP}}
\newcommand{\kCP}[1][k]{{#1}\text{-}\CP}
\newcommand{\defeq}{\triangleq}
\newcommand{\SlotDivergence}{\mathrm{div}_{\mathsf{slot}}}



%%%%%%%%%%%%%%%%%%%%%%%
% Multihonest macros
\newcommand{\h}{\mathtt{h}}
\renewcommand{\H}{\mathtt{H}}
% \newcommand{\HH}{\mathsf{H}}
\newcommand{\A}{\mathtt{A}}
\newcommand{\Hheavy}{\h\H\text{-heavy}}
\newcommand{\Aheavy}{\A\text{-heavy}}
\newcommand{\DominatedBy}{\preceq}
\newcommand{\Reduce}{\rho_\Delta}
\newcommand{\DeltaFork}{\Fork_\Delta}



%%%%%%%%%%%%%%%%%%%%%%%
% Grinding macros
\newcommand{\EpsG}{\mathsf{\varepsilon_g}}
\newcommand{\EpsA}{\mathsf{\varepsilon}_a}
\newcommand{\EpsP}{\mathsf{\varepsilon}_p}
\newcommand{\EpsTotal}{\mathsf{\varepsilon}_{total}}
\newcommand{\gSlice}{\gamma}
\newcommand{\Slice}{\mathsf{slice}}
\newcommand{\Epoch}{\mathsf{epoch}}
\newcommand{\Block}{\mathsf{block}}
\newcommand{\GameXor}{\mathcal{G}}
\newcommand{\GameNoSynch}{\GameXor_\mathsf{nosynch}}
\newcommand{\GameAllSynch}{\GameXor_\mathsf{allsynch}}
\newcommand{\BlockLength}{\ell}
\newcommand{\EpochLength}{k}
\newcommand{\NumEpochs}{L}
\newcommand{\NonceDim}{\kappa}
\newcommand{\Binomial}{\mathsf{Bin}}
\newcommand{\Poisson}{\mathsf{Poi}}
\newcommand{\PoissonBinomial}{\mathsf{PBin}}
\newcommand{\Bernoulli}{\mathsf{Ber}}
\newcommand{\Geometric}{\mathsf{Geo}}
\newcommand{\Beacon}{\mathsf{B}}
\newcommand{\Protocol}{\mathsf{P}}
\newcommand{\DoverThree}{d/3}
\newcommand{\DoverTwo}{d/2}

\DeclareMathOperator*{\Var}{\mathbf{Var}}
\DeclareMathOperator{\wt}{wt}


\DeclareRobustCommand{\Eulerian}{\genfrac<>{0pt}{}}
\DeclareMathOperator{\Li}{Li}
\newcommand{\Lifunc}{\Li_{-\lambda}(\alpha)}
\newcommand{\Geom}{\mathcal{G}}
\newcommand{\GeomAlpha}{\Geom_\alpha^+}
\newcommand{\GeomOneMinusAlpha}{\Geom_{1 - \alpha}^+}
% \newcommand{\GeomAlphaHat}{\hat{\Geometric}_\alpha}
\newcommand{\GeomAlphaHat}{\Geom_\alpha}
\newcommand{\EmptyString}{\varepsilon}
% \newcommand{\EmptyString}[1][\kappa]{0^{#1}}
\newcommand{\ZeroString}[1][\kappa]{0^{#1}}
\newcommand{\MinEntropy}{H_\infty}
\newcommand{\Indicator}{\mathbf{1}}


\newcommand{\Player}{u}
\newcommand{\Players}{\mathcal{U}}
\newcommand{\DishonestPlayers}{\mathcal{U}_A}
\newcommand{\HonestPlayers}{\mathcal{U}_H}
\newcommand{\Leaders}{\mathcal{L}}
\newcommand{\NoncePlayers}{\mathcal{N}}
\newcommand{\Endorser}{E}
\newcommand{\Nonce}{\mathsf{nonce}}
\newcommand{\BeaconProtocol}{\pi_{\mathsf{beacon}}}
\newcommand{\ECQ}{\exists\mathrm{CQ}}
\newcommand{\sECQ}[1][s]{{#1}\text{-}\ECQ}
\newcommand{\Hrule}{\noindent\rule{\textwidth}{1pt}}
\newcommand{\RandOracle}{\mathsf{H}}
\newcommand{\VRF}{\mathsf{VRF}}
\newcommand{\pk}{\mathsf{pk}}
\newcommand{\sk}{\mathsf{sk}}
\newcommand{\Or}{\text{or,}\quad}
\newcommand{\Blockchain}{\Pi_\mathsf{bc}}
\newcommand{\Astar}{\mathtt{A\star}}
\newcommand{\UniformIn}{\sim_{\mathrm{u}}}
\newcommand{\CoinTossingPrivate}{\Pi_\mathsf{private}^{\Players(\alpha),k,d}}
\newcommand{\CoinTossingPublic}{\Pi_\mathsf{public}^{\Players(\alpha),k,s,d}}
\newcommand{\LeaderElection}{\mathrm{LE}}
\newcommand{\PublicLeaderElection}{\LeaderElection_\mathsf{public}}
\newcommand{\PrivateLeaderElection}{\LeaderElection_\mathsf{private}}
\newcommand{\dMin}{d_\mathrm{min}}
\newcommand{\dMax}{d_\mathrm{max}}
\newcommand{\PrivateKey}{\mathsf{private\_key}}
\newcommand{\PublicKey}{\mathsf{public\_key}}




\newcommand{\InlineCases}[1]{
  \begin{enumerate*}[label=(\textit{\roman*})]
    #1
  \end{enumerate*}}
\newcommand{\Paragraph}[1]{\vspace{1em}\noindent\textbf{#1}\ }
\newcommand{\ParagraphEmph}[1]{\vspace{1em}\noindent\textbf{#1}\ }


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Plotting/drawing-related functions
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newtoggle{drawfigs}
\toggletrue{drawfigs}
% \togglefalse{drawfigs}

\usepackage{tikz}
\usetikzlibrary{automata,arrows,positioning,calc,math}

\usetikzlibrary{external}
\tikzexternalize

\newcommand{\PartPrefix}{dissertation}

\usepackage{pgfplots}
\pgfplotsset{compat=1.14}

% https://tex.stackexchange.com/questions/349766/pgfplots-on-tikzmath-function-with-conditionals-returns-an-error
\makeatletter
\def\tikz@math@if@@doif{%
    \pgfmathparse{\tikz@math@if@condition}%
    \ifpgfmathfloatparseactive%                 <--- Notice this
        \pgfmathfloattofixed{\pgfmathresult}%   <--- Notice this
    \fi%                                        <--- Notice this
    \ifdim\pgfmathresult pt=0pt\relax%
    \else%
        \expandafter\tikz@math\expandafter{\tikz@math@if@trueaction}%
    \fi%
    \tikz@math@parse%
}
\def\tikz@math@if@@doifelse{%
    \pgfmathparse{\tikz@math@if@condition}%
    \let\tikz@math@if@falseaction=\tikz@math@collected%
    \message{^^JCheck this: \pgfmathresult^^J}% <--- Notice this
    \ifpgfmathfloatparseactive%                 <--- Notice this
        \pgfmathfloattofixed{\pgfmathresult}%   <--- Notice this
    \fi%                                        <--- Notice this
    \message{^^JCheck again: \pgfmathresult^^J}%<--- Notice this
    \ifdim\pgfmathresult pt=0pt\relax%
        \expandafter\tikz@math\expandafter{\tikz@math@if@falseaction}%
    \else%
        \expandafter\tikz@math\expandafter{\tikz@math@if@trueaction}%
    \fi%
    \tikz@math@parse%
}
\makeatother


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% No empty lines inside \tikzmath
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\tikzmath{%
    function entropy(\prob){
      return (- \prob * ln(\prob) - (1 - \prob) * ln(1 - \prob) ) / ln(2);
    };
    % Function gamma() from praos analysis <-- not to confuse with grinding power gamma
    function PraosGamma (\e) {
      return  (1 - \e) / 2 + sqrt( 1 - \e^2 ) ;
    };
    % Function phi() from praos analysis
    function PraosPhi (\e) {
      return (3/2) * (1 + \e)^(1/3) * ( 1 - \e )^(2/3) ; 
    };
    % Function phi() from praos analysis
    function PraosPsi (\e) {
    \lnr = ln(1+\e) - ln(1-\e) ;
      return ( 1 - \lnr / ln(2) )^2 * ln(2) / 63; 
    };
    % Adversarial stake
    function Alpha(\e) {
      return (1 - \e) / 2 ; 
    };
    % Honest bias
    function Eps(\a) {
      return 1 - 2 * \a ;
    };
    % Epoch length
    function R(\e, \k) {
      return floor(16 * \k  / (1 + \e)) ; 
    };
    % Number of nonce-generating slots
    function PraosN(\e, \k) {
      return floor(R(\e, \k) * 2 / 3) ; 
    };
    % Consistency error prob
    function PraosEpsP(\e, \k) {
      \dampFactor = 1 ;  
      % \dampFactor = 1 - \e ;  
      return R(\e, \k) * exp( 1 - \e^3 * (\dampFactor) * \k / 2) ;
    };
    function LnPraosEpsP(\e, \k) {
      return ln(R(\e, \k)) + 1 - \e^3 * (1-\e) * \k / 2 ;
    };
    % ECQ parameter
    function PraosECQs(\e, \k) {
      return 8 * \k / (1 + \e) ;
    };
    % Praos GP second moment base, without the polynomial part
    function PraosVbase(\e) {
    	if (\e < 0 ) then {
    		return 1; 
    	} else {
        	if (\e <= 1/3) then {
        		return (5 - 3 * \e) / 2 ;
        	} else {
        		if (\e <= 3/5) then {
        			return 2^(2/3) * PraosPhi(\e) ;
        		} else {
        			return (5/3) * PraosPhi(\e) ;
    			};%
    		};
    	}; 
    };%
    % Praos GP second moment, full
    function PraosV(\e, \k) {
    	\s = PraosECQs(\e, \k) ;
    	\b = PraosVbase(\e) ;
    	return 0.4 * \s^2 * (1 + 2 * \e) * (\b)^(\s) ; 
    };
    function LnPraosV(\e, \k) {
    	\s = PraosECQs(\e, \k) ;
    	\b = PraosVbase(\e) ;
    	return ln(0.4 * (1 + 2 * \e) ) + 2 * ln(\s) + \s * ln(\b) ; 
    };
    function sanitizedProbability (\prob) {
        if (\prob < 0) then {
            return -inf;
        } else {
            if (\prob > 1) then {
                return +inf;
            };
        }; 
        return \prob ;
    };
    function sanitizedLnProbability (\lnprob) {
        if (\lnprob > 0) then {
            return inf;
        } else {
            return \lnprob ;
        }; 
    };
    function sanitizedMinEntropyLoss (\Rho) {
        if (\Rho < 0) then {
            return -inf;
        } else {
            return \Rho ;
        }; 
    };
    % Praos min-entropy loss in a single epoch
    function PraosMinEntropyLossSingleEpoch (\e, \k) {
        if (\e >= 0.809) then {
            return 0 ;
        } else {
        	% \g = sqrt( PraosV(\e, \k) / PraosEpsP(\e, \k) ) ;% Grinding power
        	% return ln(\g)/ln(2) ;
            if (LnPraosV(\e,\k) > LnPraosEpsP(\e,\k)) then {
                \Tau = - LnPraosEpsP(\e, \k) / ln(2) ;
            	return 0.5 * \Tau + 0.5 * LnPraosV(\e, \k) / ln(2) ;% Base-2 logarithm
            }
            else {
                return 0 ;
            };
        };
    };
    function PraosMinEntropyLossMultiEpoch (\e, \k) {
        if (\e >= 0.809) then {
            return 0 ;
        } else {
            % Probability cannot be larger than 1
            \lnepsp = LnPraosEpsP(\e, \k) ;
            if (\lnepsp >= 0) then {
                % bad 
                return -inf;% Flag value: min-entropy loss cannot be negative
            } else {
                % Logarithm of the grinding power
                % log2 sqrt( M/epsp ) where M = PraosV() is an upperbound on the second moment
                \Rho = 0.5 * (LnPraosV(\e, \k) - \lnepsp) / ln(2) ;
                return sanitizedMinEntropyLoss(\Rho) ;
            };
        };
    };
    function PraosPrBadMultiEpoch (\e, \k, \L) {
        % Probability cannot be larget than 1
        \epsp = PraosEpsP(\e, \k) ;
        if (\epsp <= 0) then {
            return -inf;
        } else {
            if (\epsp > 1) then {
                return inf;
            };
        }; 
        % Now 0 < EpsP <= 1
        \Rho = PraosMinEntropyLossMultiEpoch(\e, \k) ;
        if (\Rho >= 0) then {
            \prBad = 3 * \L * 2^\Rho * \epsp ;
            return sanitizedProbability(\prBad) ;
        } else {
            return -inf;
        };
    };
    function LnPraosPrBadMultiEpoch (\e, \k, \L) {
        \epsp = PraosEpsP(\e, \k) ;
        if (\epsp <= 0) then {
            return -inf;
        } else {
            if (\epsp > 1) then {
                return inf;
            };
        }; 
        \Rho = PraosMinEntropyLossMultiEpoch(\e, \k) ;
        if (\Rho >= 0) then {
            \lnPrBad = ln(3) + ln(\L) + \Rho * ln(2) + ln(\epsp);
            return sanitizedLnProbability(\lnPrBad) ;
        } else {
            return -inf;
        };
    };
    function PoissonBeaconMinEntropyLoss (\e, \k) {
        \epsp = PraosEpsP(\e, \k) ;
        if (\epsp <= 0) then {
            return -inf;
        } else {
            if (\epsp > 1) then {
                return inf;
            };
        }; 
        \common = 0 ;
        \extra = 0 ;
        \a = Alpha(\e) ;
        \f = ln(1 + 3 * \a + \a^2) / ln(1/\a);
        \T = PraosN(\e, \k);
        \dmax = floor((\T-\k) * ln(1/\a)/ln(1/\epsp)) ;
        % d cannot be less than 1
        \d = max(1,\dmax) ; 
        \Tkd = (\T-\k)/\d;
        \kr=\k/(\T-\k);
        \common = (\f/2) * \kr * ln(1/\epsp)/ln(2) ;
        if (\a <= 0.41 ) then {
            \extra = (1/2) * ln(\Tkd^3/((1+\a) * \epsp) )/ln(2);
        }
        else {
            \extra = (\f/2) * ln(\Tkd^(1+2/\f)/((1+\a) *\epsp) )/ln(2) ;
        };
        return sanitizedMinEntropyLoss(\common + \extra) ;
    };
    function PoissonBeaconPrBadMultiEpoch (\e, \k, \L) {
        \epsp = PraosEpsP(\e, \k) ;
        if (\epsp <= 0) then {
            return -inf;
        } else {
            if (\epsp > 1) then {
                return inf;
            };
        }; 
        \Rho = PraosMinEntropyLossMultiEpoch(\e, \k) ;
        \prBad = 3 * \L * 2^\Rho * \epsp ;
        return sanitizedProbability(\prBad) ;
    };
    function LnPoissonBeaconPrBadMultiEpoch (\e, \k, \L) {
        \epsp = PraosEpsP(\e, \k) ;
        if (\epsp <= 0) then {
            return -inf;
        } else {
            if (\epsp > 1) then {
                return +inf;
            };
        }; 
        \Rho = PraosMinEntropyLossMultiEpoch(\e, \k) ;
        \lnPrBad = ln(3) + ln(\L) + \Rho * ln(2) + ln(\epsp);
        return sanitizedLnProbability(\lnPrBad) ;
    };
    % function PoissonPraosPrBadRatio (\e, \k) {
    %     \RhoPraos = PraosMinEntropyLossMultiEpoch(\e, \k);
    %     \RhoPoisson = PoissonBeaconMinEntropyLoss(\e, \k);
    % };
    %
    %
    % XOR target games: Bernoulli
    function BernoulliBeaconMinEntropyLoss (\e, \k) {
        \epsp = PraosEpsP(\e, \k) ;
        if (\epsp <= 0) then {
            return -inf;
        } else {
            if (\epsp > 1) then {
                return inf;
            };
        }; 
        \a = Alpha(\e) ;
        \f = ln(2) / ln(1/\a) ;
        \T = PraosN(\e, \k);
        \dmax = floor((\T-\k) * ln(1/\a)/ln(1/\epsp)) ;
        % d cannot be less than 1
        \d = max(1,\dmax) ; 
        \Tkd = (\T-\k)/\d ;
        \Rho = \k/\d + 1 + \f * ln( (\Tkd/\epsp) / (1+\a) )/ln(2) ;
        return sanitizedMinEntropyLoss(\Rho) ; % Min-entropy loss is non-negative
    };
}%



%%%%%%%%%%%%%%%%%%%%
%%                   Do not edit!!!                     %%
%%%%%%%%%%%%%%%%%%%%
\input{macros.tex}
\doublespacing
